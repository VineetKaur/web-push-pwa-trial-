<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <meta http-equiv="X-UA-Compatible" content="ie=edge" />
      <title>Document</title>
   </head>
   <body>
      <button onclick="subscribe()">Enable push notifications</button>

      <div id="endpoint"></div>

      <script>
         if ("serviceWorker" in navigator) {
            navigator.serviceWorker
               .register("sw.js")
               .then(function(reg) {
                  console.log("Service Worker Registered!", reg);

                  reg.pushManager.getSubscription().then(function(sub) {
                     if (sub === null) {
                        // Update UI to ask user to register for Push
                        console.log("Not subscribed to push service!");
                     } else {
                        // We have a subscription, update the database
                        console.log("Subscription object: ", sub);
                     }
                  });
               })
               .catch(function(err) {
                  console.log("Service Worker registration failed: ", err);
               });
         }

         // addEventListener('load', async ()=>{
         //     let sw = await navigator.serviceWorker.register('./sw.js')
         //     console.log(sw);
         // })

         async function subscribe() {
            //call push manager on sw
            let sw = await navigator.serviceWorker.ready;
            let push = await sw.pushManager.subscribe({
               userVisibleOnly: true,
               applicationServerKey:
                  "BEupLAzaluKb5-uGeZbhN7H9UPMaRHk85IHD_qXZvTpBWvQZeo8Lo0Lk1cekr2iwNsl-Tdql2HyN8biVgswAJwU" //generated by web push package
               //public key on client, priv and pub on server
            });

            console.log(JSON.stringify(push)); //send back to server (api) and store in db
            // then when you want to send notifications, just iterate over these

            let div = document.getElementById("endpoint");
            div.innerHTML += JSON.stringify(push);

            let protectedUrl =
               "https://safe-city-backend-test.herokuapp.com/curPosition/heartbeat";
            let response = await fetch(protectedUrl, {
               method: "POST",
               headers: {
                  "Content-Type": "application/json;charset=utf-8",
                  Authorization:
                     "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJlbWFpbCI6ImFiY0B4eXouY29tIiwidXNlcklkIjoiNWUxZmQwNGEyNmZmYWIxMTc4ZTk1ZjBjIiwiaWF0IjoxNTc5MTcyNjMyLCJleHAiOjE1NzkxNzYyMzJ9.P3Q49bTcHLTz3gFJz1kOAcR2o5pQhGuEIWcN-m967EI"
               },
               body: {
                  long: 19.050831,
                  lat: 73.071892
               }
            }).then(function(res) {
               console.log(res);
            });
         }
      </script>
   </body>
</html>
